<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Detector (Presen√ßa com Confete)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- IA no browser -->
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <!-- Confete -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial;margin:0;padding:24px;background:#0f172a;color:#e2e8f0}
    .card{max-width:920px;margin:auto;background:#0b1220;border:1px solid #1f2a44;border-radius:16px;padding:20px;position:relative}
    h1{margin:0 0 8px}
    video{width:720px;max-width:100%;border-radius:12px;border:1px solid #1f2a44;background:#111827}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #334155;background:#111827}
    input[type=range]{width:220px}
    .ok{color:#22c55e}
    /* Overlay de confirma√ß√£o */
    .overlay{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.55); backdrop-filter: blur(2px); z-index:9999;
    }
    .overlay.show{ display:grid; }
    .overlay .box{
      background:#0b1220; border:1px solid #1f2a44; padding:28px; border-radius:16px;
      text-align:center; max-width:90vw;
      box-shadow: 0 20px 60px rgba(0,0,0,.4);
    }
    .overlay h2{ margin:0 0 6px; font-size:28px }
    .overlay p{ margin:0 0 14px; opacity:.9 }
    .overlay .name{ font-weight:700; font-size:20px }
    .overlay button{
      padding:10px 14px; border-radius:10px; border:1px solid #334155;
      background:#111827; color:#e2e8f0; cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Detector de rostos</h1>
    <p class="badge" id="status">Carregando modelos‚Ä¶</p>

    <div class="row" style="margin:8px 0 12px">
      <span class="badge">Intervalo: <b id="ivalLabel">1200</b> ms</span>
      <input id="ival" type="range" min="400" max="3000" step="100" value="1200" />
      <span class="badge">Detector: <b id="detectorKind">SSD</b></span>
      <span class="badge" id="hint">Iniciar√° automaticamente</span>
    </div>

    <video id="video" autoplay muted playsinline></video>
  </div>

  <!-- Overlay de confirma√ß√£o -->
  <div class="overlay" id="overlay">
    <div class="box">
      <h2>üéâ Presen√ßa confirmada!</h2>
      <p class="name" id="who">‚Äî</p>
      <p id="conf">conf = ‚Äî</p>
      <button id="resumeBtn">Continuar detectando</button>
    </div>
  </div>

  <script>
    // ========= Config =========
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    let DETECTOR = isMobile ? 'tiny' : 'ssd'; // tiny = mais r√°pido no celular
    const detectorKindEl = document.getElementById('detectorKind');
    detectorKindEl.textContent = DETECTOR.toUpperCase();

    // Intervalo padr√£o (um pouco maior no mobile)
    const ival = document.getElementById('ival');
    const ivalLabel = document.getElementById('ivalLabel');
    if (isMobile) { ival.value = 1600; ivalLabel.textContent = '1600'; }

    // ========= Refs =========
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const whoEl = document.getElementById('who');
    const confEl = document.getElementById('conf');
    const resumeBtn = document.getElementById('resumeBtn');

    // ========= Estado =========
    let timer = null;
    let running = false;
    let pausedForCelebration = false;

    // ========= Carregar modelos e iniciar c√¢mera =========
    (async function boot(){
      try {
        statusEl.textContent = 'Carregando modelos‚Ä¶';
        await Promise.all([
          faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
        ]);
        statusEl.textContent = 'Modelos carregados. Solicitando c√¢mera‚Ä¶';

        // Inicia c√¢mera automaticamente
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' }, audio: false
        });
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);

        statusEl.textContent = 'Detectando‚Ä¶';
        hintEl.textContent = 'Rodando automaticamente';
        startLoop(); // come√ßa j√° detectando
      } catch (e) {
        statusEl.textContent = 'Erro: ' + e.message;
        hintEl.textContent = 'D√™ permiss√£o para a c√¢mera';
      }
    })();

    ival.addEventListener('input', () => {
      ivalLabel.textContent = ival.value;
      if (running) { stopLoop(); startLoop(); }
    });

    // ========= Detec√ß√£o =========
    function tinyOpts() {
      // inputSize pode ser 160/192/224; menor = mais r√°pido
      return new faceapi.TinyFaceDetectorOptions({ inputSize: 192, scoreThreshold: 0.5 });
    }

    async function getDescriptor() {
      const chain = (DETECTOR === 'tiny')
        ? faceapi.detectSingleFace(video, tinyOpts())
        : faceapi.detectSingleFace(video);
      const det = await chain.withFaceLandmarks().withFaceDescriptor();
      return det ? Array.from(det.descriptor) : null;
    }

    function startLoop() {
      if (running) return;
      running = true;
      timer = setInterval(cycle, Number(ival.value));
    }
    function stopLoop() {
      running = false;
      if (timer) { clearInterval(timer); timer = null; }
    }

    async function cycle() {
      if (pausedForCelebration) return;
      try {
        const descriptor = await getDescriptor();
        if (!descriptor) {
          statusEl.textContent = 'Nenhum rosto no frame.';
          return;
        }
        // pergunta ao servidor ‚Äúquem √©?‚Äù
        const res = await fetch('/api/match', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ descriptor })
        });
        const json = await res.json();

        if (json.match) {
          statusEl.innerHTML = `üëâ <span class="ok">${json.name}</span> (conf=${json.score})`;
          celebrate(json.name, json.score);
        } else {
          statusEl.textContent = `Desconhecido (melhor conf=${json.score})`;
        }
      } catch (e) {
        statusEl.textContent = 'Erro: ' + e.message;
      }
    }

    // ========= Festa! (confete + overlay) =========
    function celebrate(name, score) {
      pausedForCelebration = true;
      stopLoop();

      whoEl.textContent = name;
      confEl.textContent = `conf = ${score}`;
      overlay.classList.add('show');

      // Dispara alguns bursts de confete
      burst();
      setTimeout(burst, 300);
      setTimeout(burst, 700);

      // Auto-retomar depois de 6s, se o usu√°rio n√£o clicar
      const resumeLater = setTimeout(() => {
        overlay.classList.remove('show');
        pausedForCelebration = false;
        statusEl.textContent = 'Detectando‚Ä¶';
        startLoop();
      }, 6000);

      // Se clicar no bot√£o, retoma imediatamente
      resumeBtn.onclick = () => {
        clearTimeout(resumeLater);
        overlay.classList.remove('show');
        pausedForCelebration = false;
        statusEl.textContent = 'Detectando‚Ä¶';
        startLoop();
      };
    }

    function burst() {
      // alguns estilos de confete
      const end = Date.now() + 350;
      (function frame() {
        confetti({
          particleCount: 8,
          spread: 70,
          startVelocity: 45,
          origin: { x: Math.random(), y: Math.random() * 0.4 + 0.1 }
        });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
      // chuva por baixo tamb√©m
      confetti({ particleCount: 120, spread: 100, origin: { y: 0.7 } });
    }
  </script>
</body>
</html>
